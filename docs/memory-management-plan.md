# 记忆管理优化 PoC 方案（T10）

## 背景与目标
- Shrimp Task Manager 需在长程任务中控制上下文规模，避免执行步骤与日志无限增长。
- PoC 旨在验证“分层缓存 + 裁剪策略”是否能在保留关键信息的前提下降低内存与日志占用。

## 设计原则
1. **可控缓存**：在 `data/` 新增 `memory/` 子目录，区分 `short-term`（近 10 条交互）与 `long-term`（阶段总结）。
2. **裁剪策略**：采用窗口 + 评分双策略：
   - 窗口：超过阈值（默认 50 条记录）时自动回收最旧交互。
   - 评分：优先保留带关键标签（里程碑、失败原因、回退步骤）的记录，普通记录按时间衰减。
3. **回放接口**：为 `task-manager-mcp` 增加 `memoryReplay` 工具，按任务 ID 返回最近 N 条高价值记录供复盘。
4. **安全隔离**：缓存文件仅包含必要字段（taskId、timestamp、summary、tags），剔除敏感 payload。

## PoC 步骤
| 步骤 | 说明 | 产出 |
| --- | --- | --- |
| P1 | 基准采样：记录当前长程任务的上下文大小、任务日志条数、平均查找耗时 | `.codex/testing.md` 基准段落 |
| P2 | 实现缓存抽象：在 `src/models` 定义 `MemoryStore` 接口与文件实现，支持写入/读取/裁剪 | 新模块 + 单测 |
| P3 | 集成 task 工具：`processThought`、`planTask` 等调用缓存接口写入摘要 | 工具改动与验证 |
| P4 | 实现 `memoryReplay` 工具 | 新工具输出 `structuredContent` |
| P5 | 回归测试：对比启用/关闭缓存的上下文压缩率、命中率与性能 | `.codex/testing.md` 对比表 |

## 关键指标
| 指标 | 定义 | 目标 |
| --- | --- | --- |
| 上下文压缩效率 | (原始记录行数 - 裁剪后行数) / 原始行数 | ≥ 20% |
| 命中率 | `memoryReplay` 返回的高价值记录 / 请求数量 | ≥ 0.7 |
| 平均读取耗时 | `memoryReplay` 每次读取耗时 | ≤ 50ms |
| 数据冗余率 | 缓存文件中重复记录占比 | ≤ 5% |

## 测试与验证
- 单元测试：覆盖裁剪算法、评分策略与 `memoryReplay` 输出结构。
- 集成测试：模拟 30+ 步连续任务，分别在启用/禁用缓存时运行并记录指标。
- 回归脚本：在 `.codex/testing.md` 增加 `npm run test:memory`（待新增脚本）及结果。

## 风险与缓解
- **性能抖动**：首次加载大量记录可能卡顿 ⇒ 引入懒加载与批量读取。
- **数据不一致**：同时写入可能造成竞态 ⇒ 使用文件锁或队列写入。
- **敏感信息泄漏**：摘要前删除原始 payload，仅保留必要字段。

## 里程碑
- M5.1：完成接口与数据结构设计（2025-10-15 前）。
- M5.2：实现缓存与回放工具、通过单测（2025-10-19 前）。
- M5.3：完成性能对比报告并更新文档（2025-10-21 前）。

## 当前进度
- 2025-10-12：落地文件式 MemoryStore、记忆裁剪逻辑与 `memory_replay` 工具；新增单元测试覆盖缓存裁剪、标签过滤与长短期写入。
- 2025-10-12：运行 `npm run test:memory` 基准脚本，压缩率 58%、命中率 1.0、写入耗时约 111ms、回放耗时 0.32ms，结果记录于 `.codex/testing.md`。
- 待办：补充性能基准与 `.codex/testing.md` 对比数据，完成回放命中率记录。
